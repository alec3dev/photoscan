<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Face Capture & Crop</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 10px; }
    video, canvas { max-width: 90%; border: 1px solid #ccc; margin: 5px; }
    #controls { margin-top: 10px; }
    input { width: 120px; }
  </style>
</head>
<body>
  <h2>Face Capture & Crop</h2>

  <video id="video" width="320" height="240" autoplay playsinline></video>
  <canvas id="snapshot" width="320" height="240" style="display:none;"></canvas>
  <canvas id="output" width="320" height="240"></canvas>
  <p id="status">Loading...</p>

  <div id="controls">
    <button id="take">üì∏ Take Photo</button>
    <button id="detect">üîç Detect Face</button>
    <input id="filename" placeholder="File name" />
    <button id="download">‚¨áÔ∏è Download</button>
  </div>

  <script>
    async function init() {
      const video = document.getElementById('video');
      const snapshotCanvas = document.getElementById('snapshot');
      const outputCanvas = document.getElementById('output');
      const ctxSnap = snapshotCanvas.getContext('2d');
      const ctxOut = outputCanvas.getContext('2d');
      const statusP = document.getElementById('status');

      // Check face-api loaded
      if (!window.faceapi) {
        statusP.textContent = '‚ùå face-api.js not loaded!';
        return;
      }

      // start camera
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        statusP.textContent = '‚úÖ Camera started.';
      } catch (err) {
        statusP.textContent = '‚ùå Camera error: ' + err;
        return;
      }

      // load models from CDN
      const MODEL_PATH = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_PATH);
      await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_PATH);
      statusP.textContent = '‚úÖ Models loaded. Ready.';

      // Take photo
      document.getElementById('take').onclick = () => {
        ctxSnap.drawImage(video, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
        ctxOut.drawImage(snapshotCanvas, 0, 0);
        statusP.textContent = 'üì∏ Photo taken.';
      };

      // Detect face
      document.getElementById('detect').onclick = async () => {
        statusP.textContent = 'üîç Detecting face...';
        const detection = await faceapi
          .detectSingleFace(snapshotCanvas, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks(true);

        if (!detection) {
          statusP.textContent = '‚ö†Ô∏è No face detected. Try closer/brighter.';
          return;
        }

        statusP.textContent = '‚úÖ Face detected and cropped.';

        // crop & rotate based on eyes
        const dims = faceapi.matchDimensions(outputCanvas, snapshotCanvas, true);
        const resized = faceapi.resizeResults(detection, dims);
        const { leftEye, rightEye } = resized.landmarks;

        const dx = rightEye[0].x - leftEye[0].x;
        const dy = rightEye[0].y - leftEye[0].y;
        const angle = Math.atan2(dy, dx);
        const box = resized.detection.box;

        ctxOut.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
        ctxOut.save();
        ctxOut.translate(outputCanvas.width / 2, outputCanvas.height / 2);
        ctxOut.rotate(-angle);
        ctxOut.drawImage(
          snapshotCanvas,
          box.x, box.y, box.width, box.height,
          -box.width / 2, -box.height / 2, box.width, box.height
        );
        ctxOut.restore();
      };

      // Download
      document.getElementById('download').onclick = () => {
        const name = document.getElementById('filename').value || 'face';
        const link = document.createElement('a');
        link.download = name + '.png';
        link.href = outputCanvas.toDataURL();
        link.click();
        statusP.textContent = '‚¨áÔ∏è Download started.';
      };
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
