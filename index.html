<!DOCTYPE html>
<html>
<head>
  <title>Face Extractor</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
</head>
<body>
  <h2>Upload an Image</h2>
  <input type="file" id="imageUpload" accept="image/*" />
  <div id="facesContainer"></div>

  <script>
    async function loadModels() {
      await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
    }

    function isDuplicate(box, boxes) {
      return boxes.some(b =>
        Math.abs(b.x - box.x) < 5 &&
        Math.abs(b.y - box.y) < 5 &&
        Math.abs(b.width - box.width) < 5 &&
        Math.abs(b.height - box.height) < 5
      );
    }

    document.getElementById('imageUpload').addEventListener('change', async (event) => {
      const imageFile = event.target.files[0];
      const img = await faceapi.bufferToImage(imageFile);
      document.body.append(img); // Optional: show original image

      const detections = await faceapi.detectAllFaces(img);
      const boxes = [];

      for (const detection of detections) {
        const box = detection.box;
        if (isDuplicate(box, boxes)) continue;
        boxes.push(box);

        const canvas = document.createElement('canvas');
        canvas.width = box.width;
        canvas.height = box.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(
          img,
          box.x, box.y, box.width, box.height,
          0, 0, box.width, box.height
        );

        document.getElementById('facesContainer').appendChild(canvas);
      }
    });

    loadModels();
  </script>
</body>
</html>
