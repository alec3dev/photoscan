<!DOCTYPE html>
<html>
<head>
  <title>Face Extractor & Downloader</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    #facesContainer canvas {
      margin: 10px;
      border: 1px solid #ccc;
    }
    .face-block {
      display: inline-block;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>Upload an Image</h2>
  <input type="file" id="imageUpload" accept="image/*" />
  <div id="facesContainer"></div>

  <script>
    async function loadModels() {
      await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
    }

    function isDuplicate(box, boxes) {
      return boxes.some(b =>
        Math.abs(b.x - box.x) < 5 &&
        Math.abs(b.y - box.y) < 5 &&
        Math.abs(b.width - box.width) < 5 &&
        Math.abs(b.height - box.height) < 5
      );
    }

    document.getElementById('imageUpload').addEventListener('change', async (event) => {
      const imageFile = event.target.files[0];
      const img = await faceapi.bufferToImage(imageFile);
      const detections = await faceapi.detectAllFaces(img);
      const boxes = [];

      document.getElementById('facesContainer').innerHTML = ''; // Clear previous

      for (let i = 0; i < detections.length; i++) {
        const box = detections[i].box;
        if (isDuplicate(box, boxes)) continue;
        boxes.push(box);

        const canvas = document.createElement('canvas');
        canvas.width = box.width;
        canvas.height = box.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, box.x, box.y, box.width, box.height, 0, 0, box.width, box.height);

        const dataURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `face_${i + 1}.png`;
        link.textContent = 'Download';

        const wrapper = document.createElement('div');
        wrapper.className = 'face-block';
        wrapper.appendChild(canvas);
        wrapper.appendChild(link);

        document.getElementById('facesContainer').appendChild(wrapper);
      }
    });

    loadModels();
  </script>
</body>
</html>
