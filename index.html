<script>
  const video = document.getElementById('video');
  const snapshotCanvas = document.getElementById('snapshot');
  const outputCanvas = document.getElementById('output');
  const ctxSnap = snapshotCanvas.getContext('2d');
  const ctxOut = outputCanvas.getContext('2d');

  // add a status paragraph
  const statusP = document.createElement('p');
  document.body.appendChild(statusP);

  async function init() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      const MODEL_PATH = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_PATH);
      await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_PATH);
      statusP.textContent = '‚úÖ Models loaded. Ready.';
    } catch (err) {
      statusP.textContent = 'Camera error: ' + err;
    }
  }

  document.getElementById('take').onclick = () => {
    ctxSnap.drawImage(video, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
    ctxOut.drawImage(snapshotCanvas, 0, 0);
    statusP.textContent = 'üì∏ Photo taken.';
  };

  document.getElementById('detect').onclick = async () => {
    statusP.textContent = 'üîç Detecting face...';
    const detection = await faceapi
      .detectSingleFace(snapshotCanvas, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks(true);

    if (!detection) {
      statusP.textContent = '‚ö†Ô∏è No face detected. Try closer/brighter.';
      return;
    }

    statusP.textContent = '‚úÖ Face detected and cropped.';

    // crop & rotate face based on eyes
    const dims = faceapi.matchDimensions(outputCanvas, snapshotCanvas, true);
    const resized = faceapi.resizeResults(detection, dims);
    const { leftEye, rightEye } = resized.landmarks;

    const dx = rightEye[0].x - leftEye[0].x;
    const dy = rightEye[0].y - leftEye[0].y;
    const angle = Math.atan2(dy, dx);
    const box = resized.detection.box;

    ctxOut.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
    ctxOut.save();
    ctxOut.translate(outputCanvas.width/2, outputCanvas.height/2);
    ctxOut.rotate(-angle);
    ctxOut.drawImage(
      snapshotCanvas,
      box.x, box.y, box.width, box.height,
      -box.width/2, -box.height/2, box.width, box.height
    );
    ctxOut.restore();
  };

  document.getElementById('download').onclick = () => {
    const link = document.createElement('a');
    link.download = (document.getElementById('filename').value || 'face') + '.png';
    link.href = outputCanvas.toDataURL();
    link.click();
    statusP.textContent = '‚¨áÔ∏è Download started.';
  };

  init();
</script>
